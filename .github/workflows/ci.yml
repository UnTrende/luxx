name: CI/CD

on:
  push:
    branches: [ main, master, staging ]
  pull_request:
    branches: [ main, master ]

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript Type Checking
      run: npx tsc --noEmit

    - name: Run Tests
      run: npm test

    - name: Build
      run: npm run build

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-folder
        path: dist/

  deploy-staging:
    needs: test
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    environment: staging
    steps:
    - uses: actions/checkout@v3
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
      
    - name: Link to staging project
      run: supabase link --project-ref ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}
      
    - name: Deploy database migrations
      run: supabase db push
      
    - name: Deploy Edge Functions
      run: |
        supabase functions deploy --no-verify-jwt
      
    - name: Set staging feature flags
      run: |
        supabase secrets set FF_STRICT_VALIDATION=false
        supabase secrets set FF_RATE_LIMITING=true
        supabase secrets set FF_ENHANCED_LOGGING=true
        supabase secrets set FF_CACHE_ENABLED=true
        supabase secrets set FF_SHADOW_MODE=true
        supabase secrets set ENVIRONMENT=staging
        supabase secrets set FF_GRADUAL_ROLLOUT_PERCENT=10
      
    - name: Run smoke tests
      run: |
        curl -f https://${{ secrets.SUPABASE_STAGING_PROJECT_ID }}.supabase.co/functions/v1/health || echo "Health check failed"
  
  deploy-production:
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: production
    steps:
    - uses: actions/checkout@v3
      
    - name: Wait for staging validation (24 hours)
      uses: fountainhead/action-wait-for-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        checkName: 'deploy-staging'
        timeoutSeconds: 86400
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
      
    - name: Link to production project
      run: supabase link --project-ref ${{ secrets.SUPABASE_PROD_PROJECT_ID }}
      
    - name: Deploy database migrations
      run: supabase db push
      
    - name: Deploy Edge Functions
      run: |
        supabase functions deploy --no-verify-jwt
      
    - name: Set production feature flags (gradual rollout)
      run: |
        supabase secrets set FF_STRICT_VALIDATION=true
        supabase secrets set FF_RATE_LIMITING=true
        supabase secrets set FF_ENHANCED_LOGGING=true
        supabase secrets set FF_CACHE_ENABLED=true
        supabase secrets set FF_SHADOW_MODE=false
        supabase secrets set ENVIRONMENT=production
        supabase secrets set FF_GRADUAL_ROLLOUT_PERCENT=25
      
    - name: Monitor deployment
      run: |
        # Monitor error rates for 5 minutes
        for i in {1..30}; do
          response=$(curl -s https://${{ secrets.SUPABASE_PROD_PROJECT_ID }}.supabase.co/functions/v1/health)
          status=$(echo $response | jq -r '.status')
          if [ "$status" != "healthy" ]; then
            echo "‚ùå Health check failed"
            exit 1
          fi
          sleep 10
        done